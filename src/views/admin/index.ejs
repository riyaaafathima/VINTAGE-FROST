<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Nest Dashboard</title>
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta property="og:title" content="" />
    <meta property="og:type" content="" />
    <meta property="og:url" content="" />
    <meta property="og:image" content="" />
    <!-- Favicon -->
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="assets/imgs/theme/favicon.svg"
    />
    <!-- Template CSS -->
    <link href="assets/css/main.css?v=1.1" rel="stylesheet" type="text/css" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />

    <style>
      .dashboard-header {
        background-color: #1a2533;
        padding: 15px 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }

      .modal-content {
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .modal-header {
        border-bottom: 1px solid #e9ecef;
        background-color: #f8f9fa;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
      }

      .modal-title {
        font-weight: 600;
        color: #2c3e50;
      }

      .form-label {
        font-weight: 500;
        color: #2c3e50;
        margin-bottom: 0.5rem;
      }

      .form-control {
        border-radius: 5px;
        padding: 10px 15px;
        border: 1px solid #ced4da;
        transition: border-color 0.2s;
      }

      .form-control:focus {
        border-color: #4caf50;
        box-shadow: 0 0 0 0.25rem rgba(76, 175, 80, 0.25);
      }

      .download-btn {
        background-color: #4caf50;
        border: none;
        padding: 12px;
        font-weight: 500;
        letter-spacing: 0.5px;
        transition: all 0.3s;
      }

      .download-btn:hover {
        background-color: #43a047;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .date-input-group {
        position: relative;
      }

      .calendar-icon {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        pointer-events: none;
      }

      .btn-demo {
        margin: 100px auto;
        display: block;
      }
    </style>
  </head>

  <body>
    <div class="screen-overlay"></div>
    <%- include('partials/navbar-aside') %>

    <main class="main-wrap">
      <header class="main-header navbar">
        <div class="col-search">
          <form class="searchform">
            <div class="input-group">
              <input
                list="search_terms"
                type="text"
                class="form-control"
                placeholder="Search term"
              />
              <button class="btn btn-light bg" type="button">
                <i class="material-icons md-search"></i>
              </button>
            </div>
            <datalist id="search_terms">
              <option value="Products"></option>
              <option value="New orders"></option>
              <option value="Apple iphone"></option>
              <option value="Ahmed Hassan"></option>
            </datalist>
          </form>
        </div>
        <div class="col-nav">
          <button
            class="btn btn-icon btn-mobile me-auto"
            data-trigger="#offcanvas_aside"
          >
            <i class="material-icons md-apps"></i>
          </button>
          <ul class="nav">
            <li class="nav-item">
              <a class="nav-link btn-icon" href="#">
                <i class="material-icons md-notifications animation-shake"></i>
                <span class="badge rounded-pill">3</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link btn-icon darkmode" href="#">
                <i class="material-icons md-nights_stay"></i>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="requestfullscreen nav-link btn-icon"
                ><i class="material-icons md-cast"></i
              ></a>
            </li>
            <li class="dropdown nav-item">
              <a
                class="dropdown-toggle"
                data-bs-toggle="dropdown"
                href="#"
                id="dropdownLanguage"
                aria-expanded="false"
                ><i class="material-icons md-public"></i
              ></a>
              <div
                class="dropdown-menu dropdown-menu-end"
                aria-labelledby="dropdownLanguage"
              >
                <a class="dropdown-item text-brand" href="#"
                  ><img
                    src="assets/imgs/theme/flag-us.png"
                    alt="English"
                  />English</a
                >
                <a class="dropdown-item" href="#"
                  ><img
                    src="assets/imgs/theme/flag-fr.png"
                    alt="Français"
                  />Français</a
                >
                <a class="dropdown-item" href="#"
                  ><img
                    src="assets/imgs/theme/flag-jp.png"
                    alt="Français"
                  />日本語</a
                >
                <a class="dropdown-item" href="#"
                  ><img
                    src="assets/imgs/theme/flag-cn.png"
                    alt="Français"
                  />中国人</a
                >
              </div>
            </li>
            <li class="dropdown nav-item">
              <a
                class="dropdown-toggle"
                data-bs-toggle="dropdown"
                href="#"
                id="dropdownAccount"
                aria-expanded="false"
              >
                <img
                  class="img-xs rounded-circle"
                  src="assets/imgs/people/avatar-2.png"
                  alt="User"
              /></a>
              <div
                class="dropdown-menu dropdown-menu-end"
                aria-labelledby="dropdownAccount"
              >
                <a class="dropdown-item" href="#"
                  ><i class="material-icons md-perm_identity"></i>Edit
                  Profile</a
                >
                <a class="dropdown-item" href="#"
                  ><i class="material-icons md-settings"></i>Account Settings</a
                >
                <a class="dropdown-item" href="#"
                  ><i class="material-icons md-account_balance_wallet"></i
                  >Wallet</a
                >
                <a class="dropdown-item" href="#"
                  ><i class="material-icons md-receipt"></i>Billing</a
                >
                <a class="dropdown-item" href="#"
                  ><i class="material-icons md-help_outline"></i>Help center</a
                >
                <div class="dropdown-divider"></div>
                <a class="dropdown-item text-danger" href="#"
                  ><i class="material-icons md-exit_to_app"></i>Logout</a
                >
              </div>
            </li>
          </ul>
        </div>
      </header>
      <section class="content-main">
        <div class="content-header">
          <div>
            <h2 class="content-title card-title">Dashboard</h2>
            <p>Whole data about your business here</p>
          </div>
          <div>
            <a href="#" class="btn btn-primary"
              ><i class="text-muted material-icons md-post_add"></i>Create
              report</a
            >
          </div>
        </div>
        <div class="row">
          <div class="col-lg-4">
            <div class="card card-body mb-4">
              <article class="icontext">
                <span class="icon icon-sm rounded-circle bg-success-light"
                  ><i class="text-success material-icons md-local_shipping"></i
                ></span>
                <div class="text">
                  <h6 class="mb-1 card-title">Orders</h6>
                  <span><%=totalOrders%></span>
                  <span class="text-sm"> Excluding orders in transit </span>
                </div>
              </article>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="card card-body mb-4">
              <article class="icontext">
                <span class="icon icon-sm rounded-circle bg-warning-light"
                  ><i class="text-warning material-icons md-qr_code"></i
                ></span>
                <div class="text">
                  <h6 class="mb-1 card-title">Products</h6>
                  <span><%=totalOrders%></span>
                  <span class="text-sm"> In <%=totalCategories%> categories </span>
                </div>
              </article>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="card card-body mb-4">
              <article class="icontext">
                <span class="icon icon-sm rounded-circle bg-info-light"
                  ><i class="text-info material-icons md-shopping_basket"></i
                ></span>
                <div class="text">
                  <h6 class="mb-1 card-title">Monthly Earning</h6>
                  <span>6,982</span>
                  <span class="text-sm"> Based in your local time. </span>
                </div>
              </article>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-12">
            <!-- Chart Two -->
            <div class="card mb-4">
              <article class="card-body">
                <h5 class="card-title">Sale Statistics</h5>
                <div class="dropdown mb-3">
                  <button
                    class="btn btn-secondary dropdown-toggle"
                    type="button"
                    id="timeFilterDropdown"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                  >
                    Filter by: <%= filter.charAt(0).toUpperCase() +
                    filter.slice(1) %>
                  </button>
                  <ul
                    class="dropdown-menu"
                    aria-labelledby="timeFilterDropdown"
                  >
                    <li>
                      <a class="dropdown-item" href="#" data-filter="day"
                        >Day</a
                      >
                    </li>
                    <li>
                      <a class="dropdown-item" href="#" data-filter="week"
                        >Week</a
                      >
                    </li>
                    <li>
                      <a class="dropdown-item" href="#" data-filter="month"
                        >Month</a
                      >
                    </li>
                    <li>
                      <a class="dropdown-item" href="#" data-filter="year"
                        >Year</a
                      >
                    </li>
                  </ul>
                </div>
              </article>
              <canvas id="myChart" style="height: 400px; width: 100%"></canvas>
            </div>
            <!-- <div class="row">
                  <div class="col-lg-5">
                      <div class="card mb-4">
                          <article class="card-body">
                              <h5 class="card-title">New Members</h5>
                              <div class="new-member-list">
                                  <div class="d-flex align-items-center justify-content-between mb-4">
                                      <div class="d-flex align-items-center">
                                          <img src="assets/imgs/people/avatar-4.png" alt="" class="avatar" />
                                          <div>
                                              <h6>Patric Adams</h6>
                                              <p class="text-muted font-xs">Sanfrancisco</p>
                                          </div>
                                      </div>
                                      <a href="#" class="btn btn-xs"><i class="material-icons md-add"></i> Add</a>
                                  </div>
                                  <div class="d-flex align-items-center justify-content-between mb-4">
                                      <div class="d-flex align-items-center">
                                          <img src="assets/imgs/people/avatar-2.png" alt="" class="avatar" />
                                          <div>
                                              <h6>Dilan Specter</h6>
                                              <p class="text-muted font-xs">Sanfrancisco</p>
                                          </div>
                                      </div>
                                      <a href="#" class="btn btn-xs"><i class="material-icons md-add"></i> Add</a>
                                  </div>
                                  <div class="d-flex align-items-center justify-content-between mb-4">
                                      <div class="d-flex align-items-center">
                                          <img src="assets/imgs/people/avatar-3.png" alt="" class="avatar" />
                                          <div>
                                              <h6>Tomas Baker</h6>
                                              <p class="text-muted font-xs">Sanfrancisco</p>
                                          </div>
                                      </div>
                                      <a href="#" class="btn btn-xs"><i class="material-icons md-add"></i> Add</a>
                                  </div>
                              </div>
                          </article>
                      </div>
                  </div>
                  <div class="col-lg-7">
                      <div class="card mb-4">
                          <article class="card-body">
                              <h5 class="card-title">Recent activities</h5>
                              <ul class="verti-timeline list-unstyled font-sm">
                                  <li class="event-list">
                                      <div class="event-timeline-dot">
                                          <i class="material-icons md-play_circle_outline font-xxl"></i>
                                      </div>
                                      <div class="media">
                                          <div class="me-3">
                                              <h6><span>Today</span> <i class="material-icons md-trending_flat text-brand ml-15 d-inline-block"></i></h6>
                                          </div>
                                          <div class="media-body">
                                              <div>Lorem ipsum dolor sit amet consectetur</div>
                                          </div>
                                      </div>
                                  </li>
                                  <li class="event-list active">
                                      <div class="event-timeline-dot">
                                          <i class="material-icons md-play_circle_outline font-xxl animation-fade-right"></i>
                                      </div>
                                      <div class="media">
                                          <div class="me-3">
                                              <h6><span>17 May</span> <i class="material-icons md-trending_flat text-brand ml-15 d-inline-block"></i></h6>
                                          </div>
                                          <div class="media-body">
                                              <div>Debitis nesciunt voluptatum dicta reprehenderit</div>
                                          </div>
                                      </div>
                                  </li>
                                  <li class="event-list">
                                      <div class="event-timeline-dot">
                                          <i class="material-icons md-play_circle_outline font-xxl"></i>
                                      </div>
                                      <div class="media">
                                          <div class="me-3">
                                              <h6><span>13 May</span> <i class="material-icons md-trending_flat text-brand ml-15 d-inline-block"></i></h6>
                                          </div>
                                          <div class="media-body">
                                              <div>Accusamus voluptatibus voluptas.</div>
                                          </div>
                                      </div>
                                  </li>
                                  <li class="event-list">
                                      <div class="event-timeline-dot">
                                          <i class="material-icons md-play_circle_outline font-xxl"></i>
                                      </div>
                                      <div class="media">
                                          <div class="me-3">
                                              <h6><span>05 April</span> <i class="material-icons md-trending_flat text-brand ml-15 d-inline-block"></i></h6>
                                          </div>
                                          <div class="media-body">
                                              <div>At vero eos et accusamus et iusto odio dignissi</div>
                                          </div>
                                      </div>
                                  </li>
                                  <li class="event-list">
                                      <div class="event-timeline-dot">
                                          <i class="material-icons md-play_circle_outline font-xxl"></i>
                                      </div>
                                      <div class="media">
                                          <div class="me-3">
                                              <h6><span>26 Mar</span> <i class="material-icons md-trending_flat text-brand ml-15 d-inline-block"></i></h6>
                                          </div>
                                          <div class="media-body">
                                              <div>Responded to need “Volunteer Activities</div>
                                          </div>
                                      </div>
                                  </li>
                              </ul>
                          </article>
                      </div>
                  </div>
              </div> -->
          </div>
          <!-- <div class="col-xl-4 col-lg-12">
              <div class="card mb-4">
                  <article class="card-body">
                      <h5 class="card-title">Revenue Base on Area</h5>
                      <canvas id="myChart2" height="217"></canvas>
                  </article>
              </div>
              <div class="card mb-4">
                  <article class="card-body">
                      <h5 class="card-title">Marketing Chanel</h5>
                      <span class="text-muted font-xs">Facebook</span>
                      <div class="progress mb-3">
                          <div class="progress-bar" role="progressbar" style="width: 15%">15%</div>
                      </div>
                      <span class="text-muted font-xs">Instagram</span>
                      <div class="progress mb-3">
                          <div class="progress-bar" role="progressbar" style="width: 65%">65%</div>
                      </div>
                      <span class="text-muted font-xs">Google</span>
                      <div class="progress mb-3">
                          <div class="progress-bar" role="progressbar" style="width: 51%">51%</div>
                      </div>
                      <span class="text-muted font-xs">Twitter</span>
                      <div class="progress mb-3">
                          <div class="progress-bar" role="progressbar" style="width: 80%">80%</div>
                      </div>
                      <span class="text-muted font-xs">Other</span>
                      <div class="progress mb-3">
                          <div class="progress-bar" role="progressbar" style="width: 80%">80%</div>
                      </div>
                  </article>
              </div>
          </div> -->
        </div>
        <div class="card mb-4">
          <header class="card-header">
            <h4 class="card-title">Top Selling Products</h4>
            <div class="row align-items-center">
              <div class="col-md-3 col-12 me-auto mb-md-0 mb-3"></div>
            </div>
          </header>

          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Product Name</th>
                    <th>Stock</th>
                    <th>Price</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (topProducts.length > 0) { %> <%
                  topProducts.forEach(product => { %>
                  <tr>
                    <td><%= product.productName %></td>
                    <td><%= product.totalQuantitySold %></td>
                    <td>₹<%= product.productPrice %></td>
                  </tr>
                  <% }) %> <% } else { %>
                  <tr>
                    <td colspan="4">No top-selling products available.</td>
                  </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card mb-4">
          <header class="card-header">
            <h4 class="card-title">Top Selling Categories</h4>
            <div class="row align-items-center">
              <div class="col-md-3 col-12 me-auto mb-md-0 mb-3"></div>
            </div>
          </header>

          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Category Name</th>
                    <th>Units Sold</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (topCategories.length > 0) { %> <%
                  topCategories.forEach(category => { %>
                  <tr>
                    <td><%= category.categoryName %></td>
                    <td><%= category.totalQuantitySold %></td>
                  </tr>
                  <% }) %> <% } else { %>
                  <tr>
                    <td colspan="2">No top-selling categories available.</td>
                  </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
      <!-- content-main end// -->
      <footer class="main-footer font-xs">
        <div class="row pb-30 pt-15">
          <div class="col-sm-6">
            <script>
              document.write(new Date().getFullYear());
            </script>
            &copy; Nest - HTML Ecommerce Template .
          </div>
          <div class="col-sm-6">
            <div class="text-sm-end">All rights reserved</div>
          </div>
        </div>

        <!-- ///////////////////////report modal/////////////////////// -->
        <div
          class="modal fade"
          id="salesReportModal"
          tabindex="-1"
          aria-labelledby="salesReportModalLabel"
          aria-hidden="true"
        >
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="salesReportModalLabel">
                  Download Sales Report
                </h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <div class="modal-body">
                <form id="salesReportForm">
                  <div class="mb-3">
                    <label for="startDate" class="form-label"
                      >Start Date:</label
                    >
                    <div class="date-input-group">
                      <input
                        type="date"
                        class="form-control"
                        id="startingDate"
                        value="2023-09-21"
                        required
                      />
                      <span class="calendar-icon"
                        ><i class="bi bi-calendar"></i
                      ></span>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="endDate" class="form-label">End Date:</label>
                    <div class="date-input-group">
                      <input
                        type="date"
                        class="form-control"
                        id="endingDate"
                        value="2025-03-30"
                        required
                      />
                      <span class="calendar-icon"
                        ><i class="bi bi-calendar"></i
                      ></span>
                    </div>
                  </div>
                  <div class="mb-4">
                    <label for="fileType" class="form-label">File Type:</label>
                    <select class="form-select" id="fileType" required>
                      <option value="pdf" selected>PDF</option>
                      <option value="excel">Excel</option>
                      <option value="csv">CSV</option>
                    </select>
                  </div>
                  <button
                    type="submit"
                    class="btn btn-success download-btn w-100"
                    id="salesDowloadBtn"
                  >
                    <i class="bi bi-download me-2"></i>Download
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </footer>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- https://jquery.com/download/ -->
    <!-- <script src="/assets/js/moment.min.js"></script> -->

    <script src="assets/js/vendors/jquery-3.6.0.min.js"></script>
    <!-- <script src="assets/js/vendors/bootstrap.bundle.min.js"></script> -->
    <!-- <script src="assets/js/vendors/select2.min.js"></script> -->
    <script src="assets/js/vendors/perfect-scrollbar.js"></script>
    <script src="assets/js/vendors/jquery.fullscreen.min.js"></script>
    <!-- In your index.ejs, add these scripts at the bottom  -->

    <script src="assets/js/jquery-3.3.1.min.js"></script>

    <script src="assets/js/vendors/chart.js"></script>
    <!-- <script src="assets/js/custom-chart.js" type="text/javascript"></script> -->
    <!-- Main Script -->
    <script src="assets/js/main.js?v=1.1" type="text/javascript"></script>

    <script>
      const chartData = {
        labels: JSON.parse(
          "<%= JSON.stringify(chartData.labels) %>".replace(/&#34;/g, '"')
        ),
        users: JSON.parse(
          "<%= JSON.stringify(chartData.users) %>".replace(/&#34;/g, '"')
        ),
        orders: JSON.parse(
          "<%= JSON.stringify(chartData.orders) %>".replace(/&#34;/g, '"')
        ),
        products: JSON.parse(
          "<%= JSON.stringify(chartData.products) %>".replace(/&#34;/g, '"')
        ),
      };
      console.log("chartData", chartData);

      // Chart configuration
      const ctx = document.getElementById("myChart").getContext("2d");

      const myChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: chartData.labels,
          datasets: [
            {
              label: "Users",
              tension: 0.9,
              fill: true,
              backgroundColor: 'rgba(44, 120, 220, 0.2)',
              borderColor: 'rgba(44, 120, 220)',
              data: chartData.users,
            },

            {
              label: "Orders",
              tension: 0.3,
              fill: true,
              backgroundColor: "rgba(380, 200, 230, 0.2)",
              borderColor: "rgb(380, 200, 230)",
              data: chartData.orders,
            },
            {
              label: "Products",
              tension: 0.3,
              fill: true,
              backgroundColor: "rgba(4, 209, 130, 0.2)",
              borderColor: "rgb(4, 209, 130)",
              data: chartData.products,
            },
          ],
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
            },
          },
        },
      });

      // Dropdown filter handler
      document.querySelectorAll(".dropdown-item").forEach((item) => {
        item.addEventListener("click", (e) => {
          e.preventDefault();
          const filter = e.target.getAttribute("data-filter");
          window.location.href = `/admin/dashboard?filter=${filter}`;
        });
      });
    </script>

    <script>
      // Select the button that opens the modal
      const create_report_btn_el = document.querySelector(".btn-primary");
      const salesDowloadBtn = document.querySelector("#salesDowloadBtn");
      // Bootstrap modal instance
      const salesReportModal = new bootstrap.Modal(
        document.getElementById("salesReportModal")
      );

      // Add event listener to open modal
      create_report_btn_el.addEventListener("click", (e) => {
        e.preventDefault();
        salesReportModal.show(); // Open the modal
      });

      salesDowloadBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        const startingDate = document.getElementById("startingDate").value;
        const endingDate = document.getElementById("endingDate").value;
        const fileType = document.getElementById("fileType").value;

        if (!startingDate || !endingDate || !fileType) {
          alert("Please fill in all fields", "error");
          return;
        }

        if (new Date(startingDate) > new Date(endingDate)) {
          alert("Start date must be before end date", "error");
          return;
        }

        let url;
        let fileName;
        switch (fileType) {
          case "excel":
            url = "/admin/order-generate-excel";
            fileName = "sales_report.xlsx";
            break;
          case "pdf":
            url = "/admin/order-generate-pdf";
            fileName = "sales_report.pdf";
            break;
          case "csv":
            url = "/admin/order-generate-csv";
            fileName = "sales_report.csv";
            break;
        }
        console.log(url);
        console.log(fileType);

        try {
          const response = await fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ startingDate, endingDate }),
          });

          if (response.ok) {
            alert("Downloading...", "info");
            const blob = await response.blob();
            downloadFile(blob, fileName);
            salesReportModal.close();
          } else {
            alert("Error occurred while downloading", "error");
          }
        } catch (error) {
          alert("Network error occurred", "error");
        }
      });

      function downloadFile(blob, fileName) {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.style.display = "none";
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
      }
    </script>
  </body>
</html>
